<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Descontos</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }

        .app-wrapper {
            max-width: 600px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        input, select, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        button.btn-calcular {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        button.btn-calcular:hover {
            background-color: #218838;
        }

        .botoes-acao {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-baixar {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            flex: 1;
        }

        .btn-limpar {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }

        th {
            background-color: #343a40;
            color: white;
        }

        table th:nth-child(4),
        table td:nth-child(4) {
            background-color: #fff0c2;
        }

        table tbody td:nth-child(4) {
            font-weight: bold;
        }

        .resumo {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.5;
        }

        .btn-excluir {
            background: none;
            border: none;
            color: red;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>

<body>

<div class="app-wrapper">

    <div class="container">
        <h2>Calculadora</h2>

        <label>Valor Original (R$):</label>
        <input type="number" id="valorInput" step="0.01" placeholder="Ex: 150">

        <label>Desconto:</label>
        <select id="porcentagemInput">
            <option value="15">15%</option>
            <option value="14">14%</option>
            <option value="13">13%</option>
            <option value="12">12%</option>
            <option value="11">11%</option>
        </select>

        <button class="btn-calcular" onclick="calcular()">Calcular e Adicionar</button>
    </div>

    <div class="resumo">
        Totais da Sess√£o:<br>
        Qtd: <span id="totQtd">0</span> |
        Orig: R$ <span id="totOriginal">0</span> |
        Final: R$ <span id="totFinal">0</span> |
        Lucro: R$ <span id="totLucro">0</span>

        <div class="botoes-acao">
            <button class="btn-baixar" onclick="baixarPlanilha()">Baixar (CSV)</button>
            <button class="btn-limpar" onclick="limparHistorico()">Limpar Tudo</button>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th>Hora</th>
            <th>Orig.</th>
            <th>%</th>
            <th>Final</th>
            <th>11%</th>
            <th>Lucro</th>
            <th>üóëÔ∏è</th>
        </tr>
        </thead>
        <tbody id="tabelaLog"></tbody>
    </table>

</div>

<script>
    const STORAGE_KEY = "historicoCalculadora_v3";

    let itens = [];
    let somaOriginal = 0;
    let somaFinal = 0;
    let somaLucro = 0;

    const elValor = document.getElementById("valorInput");
    const elPct = document.getElementById("porcentagemInput");
    const elTabela = document.getElementById("tabelaLog");

    const elTotQtd = document.getElementById("totQtd");
    const elTotOriginal = document.getElementById("totOriginal");
    const elTotFinal = document.getElementById("totFinal");
    const elTotLucro = document.getElementById("totLucro");

    function arredondaPraCima(valor) {
        return Math.ceil(Number(valor));
    }

    function horaAgora() {
        const agora = new Date();
        return [
            agora.getHours().toString().padStart(2, "0"),
            agora.getMinutes().toString().padStart(2, "0"),
            agora.getSeconds().toString().padStart(2, "0")
        ].join(":");
    }

    function atualizarTotais() {
        elTotQtd.innerText = itens.length;
        elTotOriginal.innerText = somaOriginal;
        elTotFinal.innerText = somaFinal;
        elTotLucro.innerText = somaLucro;
    }

    function salvar() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            itens,
            somaOriginal,
            somaFinal,
            somaLucro
        }));
    }

    function carregar() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        try {
            const dados = JSON.parse(raw);
            itens = dados.itens || [];
            somaOriginal = dados.somaOriginal || 0;
            somaFinal = dados.somaFinal || 0;
            somaLucro = dados.somaLucro || 0;

            renderTabela();
            atualizarTotais();
        } catch {
            localStorage.removeItem(STORAGE_KEY);
        }
    }

    function renderTabela() {
        elTabela.innerHTML = "";

        [...itens].reverse().forEach(item => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${item.hora}</td>
                <td>R$ ${item.valor}</td>
                <td>${item.percentual}%</td>
                <td>R$ ${item.final}</td>
                <td>R$ ${item.valor11}</td>
                <td>R$ ${item.lucro}</td>
                <td><button class="btn-excluir" data-id="${item.id}">‚ùå</button></td>
            `;

            elTabela.appendChild(tr);
        });
    }

    function calcular() {
        const valorInput = elValor.value;

        if (!valorInput || Number(valorInput) <= 0) {
            alert("Insira um valor v√°lido maior que zero.");
            return;
        }

        const valor = arredondaPraCima(valorInput);
        const percentual = Number(elPct.value);

        const final = arredondaPraCima(valor - (valor * percentual / 100));
        const valor11 = arredondaPraCima(valor - (valor * 0.11));
        const lucro = arredondaPraCima(valor11 - final);

        const item = {
            id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
            hora: horaAgora(),
            valor,
            percentual,
            final,
            valor11,
            lucro
        };

        itens.push(item);

        somaOriginal += valor;
        somaFinal += final;
        somaLucro += lucro;

        renderTabela();
        atualizarTotais();
        salvar();

        elValor.value = "";
        elValor.focus();
    }

    function excluirPorId(id) {
        const idx = itens.findIndex(x => x.id === id);
        if (idx === -1) return;

        const item = itens[idx];

        somaOriginal -= item.valor;
        somaFinal -= item.final;
        somaLucro -= item.lucro;

        itens.splice(idx, 1);

        renderTabela();
        atualizarTotais();
        salvar();
    }

    elTabela.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-id]");
        if (!btn) return;
        excluirPorId(btn.dataset.id);
    });

    function baixarPlanilha() {
        if (itens.length === 0) {
            alert("A tabela est√° vazia.");
            return;
        }

        const header = ["Hora", "Orig", "%", "Final", "11%", "Lucro"];
        const linhas = itens.map(i => [
            i.hora,
            i.valor,
            i.percentual,
            i.final,
            i.valor11,
            i.lucro
        ]);

        const csv = [header, ...linhas].map(l => l.join(";")).join("\n");

        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "historico_calculos.csv";
        link.click();
    }

    function limparHistorico() {
        if (!confirm("Tem certeza que deseja apagar todo o hist√≥rico?")) return;

        itens = [];
        somaOriginal = 0;
        somaFinal = 0;
        somaLucro = 0;

        renderTabela();
        atualizarTotais();
        localStorage.removeItem(STORAGE_KEY);
    }

    elValor.addEventListener("keydown", (e) => {
        if (e.key === "Enter") calcular();
    });

    window.calcular = calcular;
    window.baixarPlanilha = baixarPlanilha;
    window.limparHistorico = limparHistorico;

    window.addEventListener("load", carregar);
</script>

</body>
</html>