<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Descontos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .app-wrapper { max-width: 600px; } /* Aumentei um pouquinho pra caber o X */
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        
        button.btn-calcular { background-color: #28a745; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }
        button.btn-calcular:hover { background-color: #218838; }
        
        .botoes-acao { margin-top: 10px; display: flex; gap: 10px; }
        .btn-baixar { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; padding: 10px; flex: 1; }
        .btn-baixar:hover { background-color: #0056b3; }
        .btn-limpar { background-color: #dc3545; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; padding: 10px; flex: 1; }
        .btn-limpar:hover { background-color: #c82333; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #343a40; color: white; }
        
        .resumo { background: #e9ecef; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 14px; line-height: 1.5; }
        
        table th:nth-child(4), table td:nth-child(4) { background-color: #fff0c2; }
        table thead th:nth-child(4) { color: #212529; }
        table tbody td:nth-child(4) { font-weight: bold; }

        /* Estilo pro bot√£o de apagar a linha */
        .btn-excluir { background: none; border: none; color: red; cursor: pointer; font-size: 16px; padding: 0; width: auto; margin: 0; }
        .btn-excluir:hover { transform: scale(1.2); }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="container">
            <h2>Calculadora</h2>
            
            <label>Valor Original (R$):</label>
            <input type="number" id="valorInput" placeholder="Ex: 150.00" step="0.01">
            
            <label>Desconto:</label>
            <select id="porcentagemInput">
                <option value="15">15%</option>
                <option value="14">14%</option>
                <option value="13">13%</option>
                <option value="12">12%</option>
                <option value="11">11%</option>
            </select>
            
            <button class="btn-calcular" onclick="calcular()">Calcular e Adicionar</button>
        </div>

        <div class="resumo">
            Totais da Sess√£o: <br>
            Qtd: <span id="totQtd">0</span> | 
            Orig: R$ <span id="totOriginal">0</span> | 
            Final: R$ <span id="totFinal">0</span> | 
            Lucro: R$ <span id="totLucro">0</span>
            
            <div class="botoes-acao">
                <button class="btn-baixar" onclick="baixarPlanilha()">Baixar (CSV)</button>
                <button class="btn-limpar" onclick="limparHistorico()">Limpar Tudo</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Orig.</th>
                    <th>%</th>
                    <th>Final</th>
                    <th>11%</th>
                    <th>Lucro</th>
                    <th>üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody id="tabelaLog">
            </tbody>
        </table>
    </div>

    <script>
        let somaOriginal = 0;
        let somaFinal = 0;
        let somaLucro = 0;
        let contagem = 0;

        // Carrega os dados salvos assim que a p√°gina abre
        window.onload = function() {
            let dadosSalvos = localStorage.getItem("historicoCalculadora");
            if (dadosSalvos) {
                let dados = JSON.parse(dadosSalvos);
                somaOriginal = dados.somaOriginal;
                somaFinal = dados.somaFinal;
                somaLucro = dados.somaLucro || 0; // || 0 pra evitar erro se carregar um save antigo
                contagem = dados.contagem;
                
                document.getElementById("totQtd").innerText = contagem;
                document.getElementById("totOriginal").innerText = somaOriginal;
                document.getElementById("totFinal").innerText = somaFinal;
                document.getElementById("totLucro").innerText = somaLucro;
                document.getElementById("tabelaLog").innerHTML = dados.tabelaHTML;
            }
        };

        // Fun√ß√£o para salvar no navegador
        function salvarNoNavegador() {
            let dados = {
                somaOriginal: somaOriginal,
                somaFinal: somaFinal,
                somaLucro: somaLucro,
                contagem: contagem,
                tabelaHTML: document.getElementById("tabelaLog").innerHTML
            };
            localStorage.setItem("historicoCalculadora", JSON.stringify(dados));
        }

        function calcular() {
            let valorInput = document.getElementById("valorInput").value;
            let porcentagem = document.getElementById("porcentagemInput").value;

            if (valorInput === "" || valorInput <= 0) {
                alert("Insira um valor v√°lido maior que zero.");
                return;
            }

            let valor = Math.ceil(parseFloat(valorInput));
            let percentual = parseFloat(porcentagem);
            
            let valorDescontado = Math.ceil(valor - (valor * (percentual / 100)));
            let valor11 = Math.ceil(valor - (valor * 0.11));
            let lucro = valor11 - valorDescontado;

            contagem++;
            somaOriginal += valor;
            somaFinal += valorDescontado;
            somaLucro += lucro;

            document.getElementById("totQtd").innerText = contagem;
            document.getElementById("totOriginal").innerText = somaOriginal;
            document.getElementById("totFinal").innerText = somaFinal;
            document.getElementById("totLucro").innerText = somaLucro;

            let agora = new Date();
            let horaFormatada = agora.getHours().toString().padStart(2, '0') + ":" + 
                                agora.getMinutes().toString().padStart(2, '0') + ":" + 
                                agora.getSeconds().toString().padStart(2, '0');

            let tabela = document.getElementById("tabelaLog");
            let novaLinha = tabela.insertRow(0); 

            novaLinha.insertCell(0).innerText = horaFormatada;
            novaLinha.insertCell(1).innerText = "R$ " + valor;
            novaLinha.insertCell(2).innerText = percentual + "%";
            novaLinha.insertCell(3).innerText = "R$ " + valorDescontado;
            novaLinha.insertCell(4).innerText = "R$ " + valor11;
            novaLinha.insertCell(5).innerText = "R$ " + lucro;
            
            // Cria a c√©lula do bot√£o X com os valores embutidos pra poder subtrair depois
            novaLinha.insertCell(6).innerHTML = `<button class="btn-excluir" onclick="deletarLinha(this, ${valor}, ${valorDescontado}, ${lucro})">‚ùå</button>`;

            salvarNoNavegador();

            document.getElementById("valorInput").value = "";
            document.getElementById("valorInput").focus();
        }

        function deletarLinha(botao, valorOriginalLinha, valorFinalLinha, lucroLinha) {
            // Subtrai os valores da linha apagada dos totais globais
            contagem--;
            somaOriginal -= valorOriginalLinha;
            somaFinal -= valorFinalLinha;
            somaLucro -= lucroLinha;

            // Atualiza os textos l√° em cima
            document.getElementById("totQtd").innerText = contagem;
            document.getElementById("totOriginal").innerText = somaOriginal;
            document.getElementById("totFinal").innerText = somaFinal;
            document.getElementById("totLucro").innerText = somaLucro;

            // Apaga a linha inteira da tabela
            let linha = botao.parentNode.parentNode;
            linha.parentNode.removeChild(linha);

            // Salva o novo estado sem a linha
            salvarNoNavegador();
        }

        function baixarPlanilha() {
            let csv = [];
            let linhas = document.querySelectorAll("table tr");
            
            if (linhas.length <= 1) {
                alert("A tabela est√° vazia. Calcule algo primeiro antes de baixar.");
                return;
            }
            
            for (let i = 0; i < linhas.length; i++) {
                let linha = [];
                let colunas = linhas[i].querySelectorAll("td, th");
                
                // Vai s√≥ at√© o length - 1 para ignorar a coluna do bot√£o X
                for (let j = 0; j < colunas.length - 1; j++) {
                    let texto = colunas[j].innerText.replace("R$ ", "");
                    linha.push(texto);
                }
                csv.push(linha.join(";"));
            }

            let csvString = "\uFEFF" + csv.join("\n"); 
            let blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "historico_calculos.csv";
            link.click();
        }

        function limparHistorico() {
            if(confirm("Tem certeza que deseja apagar todo o hist√≥rico?")) {
                somaOriginal = 0;
                somaFinal = 0;
                somaLucro = 0;
                contagem = 0;

                document.getElementById("totQtd").innerText = "0";
                document.getElementById("totOriginal").innerText = "0";
                document.getElementById("totFinal").innerText = "0";
                document.getElementById("totLucro").innerText = "0";
                document.getElementById("tabelaLog").innerHTML = "";

                localStorage.removeItem("historicoCalculadora");
            }
        }
    </script>

</body>
</html>
